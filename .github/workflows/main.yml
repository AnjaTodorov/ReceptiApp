name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-backend:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8
        options: --env MYSQL_ROOT_PASSWORD=Konstantinslovenija2023 --env MYSQL_DATABASE=ReceptiDB --health-cmd="mysqladmin ping --silent" --health-timeout=10s --health-retries=5 --health-start-period=30s
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Create application.properties for MySQL
        run: |
          echo "spring.datasource.url=jdbc:mysql://mysql:3306/ReceptiDB" > ./backend/src/main/resources/application.properties
          echo "spring.datasource.username=root" >> ./backend/src/main/resources/application.properties
          echo "spring.datasource.password=Konstantinslovenija2023" >> ./backend/src/main/resources/application.properties
          echo "spring.jpa.hibernate.ddl-auto=update" >> ./backend/src/main/resources/application.properties
          echo "spring.jpa.show-sql=true" >> ./backend/src/main/resources/application.properties
          echo "spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect" >> ./backend/src/main/resources/application.properties
          echo "spring.application.name=Moji-recepti" >> ./backend/src/main/resources/application.properties
          echo "server.port=8080" >> ./backend/src/main/resources/application.properties

      - name: Wait for MySQL to be ready
        run: |
          until mysql -h 127.0.0.1 -u root -p'Konstantinslovenija2023' -e 'SHOW DATABASES'; do
            echo "Waiting for database to be ready..."
            sleep 5
          done

      - name: Build Backend
        run: mvn clean install --no-transfer-progress
        working-directory: ./backend

  scan-backend:
    runs-on: ubuntu-latest
    needs: build-backend
    services:
      sonarqube:
        image: sonarqube:10.4.1-community  # Use specific version
        options: >-
          --health-cmd="curl -f http://localhost:9000 || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=30
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: true
          SONAR_FORCEAUTHENTICATION: false  # Allow unauthenticated access initially
        ports:
          - 9000:9000

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Wait for SonarQube
        run: |
          echo "Waiting for SonarQube to be ready..."
          # Wait longer for SonarQube to fully start
          for i in {1..90}; do
            if curl -s -f http://localhost:9000/api/system/status | grep -q '"status":"UP"'; then
              echo "SonarQube is ready and UP!"
              break
            fi
            echo "Waiting for SonarQube to start... ($i/90)"
            sleep 10
          done
          
          # Additional wait to ensure fully initialized
          sleep 30

      - name: Setup SonarQube Authentication
        run: |
          # First, check if we can access without authentication
          echo "Testing SonarQube access..."
          
          # Try to get version without auth
          VERSION=$(curl -s http://localhost:9000/api/server/version || echo "failed")
          echo "SonarQube version: $VERSION"
          
          # Generate a token for analysis
          echo "Generating SonarQube token..."
          
          # Try to generate token with default admin password
          TOKEN_RESPONSE=$(curl -s -u admin:admin -X POST "http://localhost:9000/api/user_tokens/generate" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "name=github-action-$(date +%s)" || echo "token_failed")
          
          if echo "$TOKEN_RESPONSE" | grep -q "token"; then
            # Extract token from JSON response
            SONAR_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
            echo "Generated token successfully"
            echo "SONAR_TOKEN=$SONAR_TOKEN" >> $GITHUB_ENV
          else
            # If token generation fails, try to disable authentication temporarily
            echo "Failed to generate token, checking authentication requirements..."
            
            # Check if authentication is forced
            AUTH_STATUS=$(curl -s http://localhost:9000/api/authentication/validate | grep -o '"forceAuthentication":[^,]*' | cut -d':' -f2)
            
            if [ "$AUTH_STATUS" = "false" ]; then
              echo "Authentication not forced, proceeding without token"
              echo "SONAR_TOKEN=" >> $GITHUB_ENV
            else
              # Try to create a user for analysis
              echo "Creating analysis user..."
              curl -s -u admin:admin -X POST "http://localhost:9000/api/users/create" \
                -H "Content-Type: application/x-www-form-urlencoded" \
                -d "login=analysis" \
                -d "name=Analysis User" \
                -d "password=analysis123" || true
              
              # Generate token for the new user
              TOKEN_RESPONSE=$(curl -s -u analysis:analysis123 -X POST "http://localhost:9000/api/user_tokens/generate" \
                -H "Content-Type: application/x-www-form-urlencoded" \
                -d "name=github-action" || echo "token_failed2")
                
              if echo "$TOKEN_RESPONSE" | grep -q "token"; then
                SONAR_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
                echo "Generated token for analysis user"
                echo "SONAR_TOKEN=$SONAR_TOKEN" >> $GITHUB_ENV
              else
                echo "WARNING: Could not generate token, analysis may fail"
                echo "SONAR_TOKEN=" >> $GITHUB_ENV
              fi
            fi
          fi
          
          echo "Authentication setup complete"

      - name: Run SonarQube Analysis
        run: |
          if [ -n "${{ env.SONAR_TOKEN }}" ]; then
            echo "Running analysis with token authentication"
            mvn verify org.sonarsource.scanner.maven:sonar-maven-plugin:5.5.0.6356:sonar \
              -Dsonar.projectKey=com.ris:Moji-recepti \
              -Dsonar.host.url=http://localhost:9000 \
              -Dsonar.token=${{ env.SONAR_TOKEN }}
          else
            echo "Running analysis without authentication"
            mvn verify org.sonarsource.scanner.maven:sonar-maven-plugin:5.5.0.6356:sonar \
              -Dsonar.projectKey=com.ris:Moji-recepti \
              -Dsonar.host.url=http://localhost:9000
          fi
        working-directory: ./backend

  build-frontend:
    runs-on: ubuntu-latest
    needs: build-backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
  
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
  
      - name: Cache npm modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
  
      - name: Install Dependencies
        run: npm install
        working-directory: .
  
      - name: Start Frontend Server
        run: nohup node server.js &
        working-directory: .

      - name: Wait for Server to Start
        run: sleep 30 

  test-backend:
    runs-on: ubuntu-latest
    needs: build-frontend
    services:
      mysql:
        image: mysql:8
        options: --env MYSQL_ROOT_PASSWORD=Konstantinslovenija2023 --env MYSQL_DATABASE=ReceptiDB --health-cmd="mysqladmin ping --silent" --health-timeout=10s --health-retries=5 --health-start-period=30s
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Wait for MySQL to be ready
        run: |
          until mysql -h 127.0.0.1 -u root -p'Konstantinslovenija2023' -e 'SHOW DATABASES'; do
            echo "Waiting for database to be ready..."
            sleep 5
          done

      - name: Run Unit Tests
        run: mvn test --no-transfer-progress
        working-directory: ./backend
